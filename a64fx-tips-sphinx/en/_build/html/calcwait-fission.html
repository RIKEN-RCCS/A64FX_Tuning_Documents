

<!doctype html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>3.1. Fission of Loop with Large Loop Body &#8212; Documentation of Tuning Techniques for A64FX Processors</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="_static/bizstyle.css?v=532c1bf3" />
    
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/bizstyle.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3.2. Striping of Innermost Loop with Small Iteration Count" href="calcwait-striping.html" />
    <link rel="prev" title="3. Reduction of Waiting Time for Calculation" href="calcwait.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="calcwait-striping.html" title="3.2. Striping of Innermost Loop with Small Iteration Count"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="calcwait.html" title="3. Reduction of Waiting Time for Calculation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Documentation of Tuning Techniques for A64FX Processors</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="calcwait.html" accesskey="U"><span class="section-number">3. </span>Reduction of Waiting Time for Calculation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3.1. </span>Fission of Loop with Large Loop Body</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="fission-of-loop-with-large-loop-body">
<h1><span class="section-number">3.1. </span>Fission of Loop with Large Loop Body<a class="headerlink" href="#fission-of-loop-with-large-loop-body" title="Link to this heading">¶</a></h1>
<section id="motivation">
<h2><span class="section-number">3.1.1. </span>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">¶</a></h2>
<p>Fujitsu Fortran/C/C++ compilers try to apply a compiler optimization of software pipelining for exploiting computational performance of A64FX processors.
However, since this optimization consumes more floating-point/integer/predicate registers on A64FX processors than usual, there are cases where the software pipelining can not be applied due to register shortage when a loop of optimization target has a large loop body.</p>
<p>In such cases, users can
<strong>advise the compilers to distribute a loop with a large loop body automatically</strong>,
by inserting an Optimization Control Line (OCL) of “loop_fission_target” into the source program.</p>
<p>As a result, a loop with a large loop body on the source program is treated by the compilers as several loops with small loop bodies so that compiler optimizations such as the software pipelining and register allocation are promoted and it might lead to reduction of execution time.</p>
</section>
<section id="applied-example">
<h2><span class="section-number">3.1.2. </span>Applied Example<a class="headerlink" href="#applied-example" title="Link to this heading">¶</a></h2>
<p>Referring to an example presented in
<a class="reference external" href="https://www.hpci-office.jp/en/events/symposia/meetings_A64FX">“Meetings for application code tuning on A64FX computer systems”</a>,
performance improvement by applying this technique is shown below.
In this example, an OCL of “loop_fission_target” was added to a loop for do-variable ii, which has a large loop body.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Original</span><a class="headerlink" href="#id1" title="Link to this code">¶</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="n">cumcnt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">cumcnt</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span>
<span class="w">     </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">i</span>
<span class="w">     </span><span class="n">s0x</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">     </span><span class="n">s0x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s0x</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="o">-</span><span class="n">dh</span><span class="o">*</span><span class="n">dh</span>
<span class="w">     </span><span class="n">s0x</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s0x</span><span class="p">(</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">     </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">j</span>
<span class="w">     </span><span class="n">s0y</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">     </span><span class="n">s0y</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s0y</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="o">-</span><span class="n">dh</span><span class="o">*</span><span class="n">dh</span>
<span class="w">     </span><span class="n">s0y</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s0y</span><span class="p">(</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">     </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">k</span>
<span class="w">     </span><span class="n">s0z</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">     </span><span class="n">s0z</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s0z</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="o">-</span><span class="n">dh</span><span class="o">*</span><span class="n">dh</span>
<span class="w">     </span><span class="n">s0z</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s0z</span><span class="p">(</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">     </span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="n">gp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="p">)</span>
<span class="w">     </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">i2</span>
<span class="w">     </span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2</span><span class="o">-</span><span class="n">i</span>
<span class="w">     </span><span class="n">s1_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s1_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="o">-</span><span class="n">dh</span><span class="o">*</span><span class="n">dh</span>
<span class="w">     </span><span class="n">s1_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">smo_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">inc</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mi">0</span>
<span class="w">     </span><span class="n">smo_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
<span class="w">     </span><span class="n">smo_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">inc</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mi">0</span>
<span class="w">     </span><span class="n">dsx</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_1</span>
<span class="w">     </span><span class="n">dsx</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_1</span>
<span class="w">     </span><span class="n">dsx</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_1</span><span class="o">+</span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">dsx</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">dsx</span><span class="p">(</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="n">gp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="p">)</span>
<span class="w">     </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">i2</span>
<span class="w">     </span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2</span><span class="o">-</span><span class="n">j</span>
<span class="w">     </span><span class="n">s1_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s1_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="o">-</span><span class="n">dh</span><span class="o">*</span><span class="n">dh</span>
<span class="w">     </span><span class="n">s1_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">smo_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">inc</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mi">0</span>
<span class="w">     </span><span class="n">smo_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
<span class="w">     </span><span class="n">smo_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">inc</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mi">0</span>
<span class="w">     </span><span class="n">dsy</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_1</span>
<span class="w">     </span><span class="n">dsy</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_1</span>
<span class="w">     </span><span class="n">dsy</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_1</span><span class="o">+</span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">dsy</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">dsy</span><span class="p">(</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="n">gp</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="p">)</span>
<span class="w">     </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gp</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">idelx</span><span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">i2</span>
<span class="w">     </span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2</span><span class="o">-</span><span class="n">k</span>
<span class="w">     </span><span class="n">s1_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">s1_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="o">-</span><span class="n">dh</span><span class="o">*</span><span class="n">dh</span>
<span class="w">     </span><span class="n">s1_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">+</span><span class="n">dh</span><span class="p">)</span>
<span class="w">     </span><span class="n">smo_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">inc</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mi">0</span>
<span class="w">     </span><span class="n">smo_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
<span class="w">     </span><span class="n">smo_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">inc</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">inc</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mi">0</span>
<span class="w">     </span><span class="n">dsz</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_1</span>
<span class="w">     </span><span class="n">dsz</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_1</span>
<span class="w">     </span><span class="n">dsz</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_1</span><span class="o">+</span><span class="n">s1_1</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">dsz</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_2</span><span class="o">+</span><span class="n">s1_2</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">dsz</span><span class="p">(</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1_3</span><span class="o">*</span><span class="n">smo_3</span>
<span class="w">     </span><span class="n">dsx</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsx</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">s0x</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<span class="w">     </span><span class="n">dsy</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsy</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">s0y</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<span class="w">     </span><span class="n">dsz</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsz</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">s0z</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<span class="c">!OCL UNROLL(&#39;FULL&#39;)</span>
<span class="w">     </span><span class="k">do </span><span class="n">kp</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span>
<span class="w">        </span><span class="k">do </span><span class="n">jp</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span>
<span class="w">           </span><span class="n">pjtmpx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">           </span><span class="n">pjtmpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">           </span><span class="n">pjtmpz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.D0</span>
<span class="w">           </span><span class="n">dstmpx</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span><span class="n">s0y</span><span class="p">(</span><span class="n">jp</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dsy</span><span class="p">(</span><span class="n">jp</span><span class="p">))</span><span class="o">*</span><span class="n">s0z</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                </span><span class="o">+</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">s0y</span><span class="p">(</span><span class="n">jp</span><span class="p">)</span><span class="o">+</span><span class="n">fac</span><span class="o">*</span><span class="n">dsy</span><span class="p">(</span><span class="n">jp</span><span class="p">))</span><span class="o">*</span><span class="n">dsz</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>
<span class="w">           </span><span class="n">dstmpy</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span><span class="n">s0x</span><span class="p">(</span><span class="n">jp</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dsx</span><span class="p">(</span><span class="n">jp</span><span class="p">))</span><span class="o">*</span><span class="n">s0z</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                </span><span class="o">+</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">s0x</span><span class="p">(</span><span class="n">jp</span><span class="p">)</span><span class="o">+</span><span class="n">fac</span><span class="o">*</span><span class="n">dsx</span><span class="p">(</span><span class="n">jp</span><span class="p">))</span><span class="o">*</span><span class="n">dsz</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>
<span class="w">           </span><span class="n">dstmpz</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span><span class="n">s0x</span><span class="p">(</span><span class="n">jp</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dsx</span><span class="p">(</span><span class="n">jp</span><span class="p">))</span><span class="o">*</span><span class="n">s0y</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                </span><span class="o">+</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">s0x</span><span class="p">(</span><span class="n">jp</span><span class="p">)</span><span class="o">+</span><span class="n">fac</span><span class="o">*</span><span class="n">dsx</span><span class="p">(</span><span class="n">jp</span><span class="p">))</span><span class="o">*</span><span class="n">dsy</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>
<span class="w">           </span><span class="k">do </span><span class="n">ip</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span>
<span class="w">              </span><span class="n">pjtmpx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pjtmpx</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">delx</span><span class="o">*</span><span class="n">idelt</span><span class="o">*</span><span class="n">dsx</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">*</span><span class="n">dstmpx</span>
<span class="w">              </span><span class="n">pjtmpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pjtmpy</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">delx</span><span class="o">*</span><span class="n">idelt</span><span class="o">*</span><span class="n">dsy</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">*</span><span class="n">dstmpy</span>
<span class="w">              </span><span class="n">pjtmpz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pjtmpz</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="n">isp</span><span class="p">)</span><span class="o">*</span><span class="n">delx</span><span class="o">*</span><span class="n">idelt</span><span class="o">*</span><span class="n">dsz</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">*</span><span class="n">dstmpz</span>
<span class="w">              </span><span class="n">pjx</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pjx</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span><span class="n">pjtmpx</span>
<span class="w">              </span><span class="n">pjy</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pjy</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span><span class="n">pjtmpy</span>
<span class="w">              </span><span class="n">pjz</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pjz</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span><span class="n">pjtmpz</span>
<span class="w">           </span><span class="k">enddo</span>
<span class="k">        enddo</span>
<span class="k">     enddo</span>
<span class="k">  enddo</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Technique applied</span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="c">!OCL LOOP_FISSION_TARGET(LS)</span>
</span><span class="w">  </span><span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="n">cumcnt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">cumcnt</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">isp</span><span class="p">)</span>
<span class="w">     </span><span class="p">...</span>
<span class="w">  </span><span class="k">enddo</span>
</pre></div>
</div>
</div>
<p>Results of cycle accounting for executions before/after applying the technique are shown in graphs below.
A parameter for the loop execution is as follows:</p>
<blockquote>
<div><p>cumcnt(i+1,j,k,isp) - cumcnt(i,j,k,isp) = 20</p>
</div></blockquote>
<p>Comparing the right graph for the technique applied to the left graph for the original, busy and waiting time for integer calculation decreased dramatically and execution time was reduced by 44%.
At the time, decrease of busy and waiting time for L1D cache access is considered as a result of suppressing register spill/fill behavior of the processor by loop fission.</p>
<a class="reference internal image-reference" href="_images/elecur.29503716.0.png"><img alt="_images/elecur.29503716.0.png" src="_images/elecur.29503716.0.png" style="width: 49%;" /></a>
<a class="reference internal image-reference" href="_images/elecur.29503716.2.png"><img alt="_images/elecur.29503716.2.png" src="_images/elecur.29503716.2.png" style="width: 49%;" /></a>
</section>
<section id="real-cases">
<h2><span class="section-number">3.1.3. </span>Real Cases<a class="headerlink" href="#real-cases" title="Link to this heading">¶</a></h2>
<p>Real cases related to this technique are presented in
<a class="reference external" href="https://www.hpci-office.jp/en/events/symposia/meetings_A64FX">“Meetings for application code tuning on A64FX computer systems”</a>
as follows:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.hpci-office.jp/documents/meeting_A64FX/201223/LQCD_A64FX_20201223.pdf#page=17">LQCD tuning on Fugaku</a></p></li>
<li><p><a class="reference external" href="https://www.hpci-office.jp/documents/meeting_A64FX/210427/lmp_tune_for_a64fx_27Apr2021_final.pdf#page=20">Performance tuning on LAMMPS for A64FX system</a></p></li>
<li><p><a class="reference external" href="https://www.hpci-office.jp/documents/meeting_A64FX/210427/Tuning_of_FFVHC-ACE.pdf#page=15">CPU and Thread Parallelization Tuning of FFVHC-ACE on Fugaku</a></p></li>
<li><p><a class="reference external" href="https://www.hpci-office.jp/documents/meeting_A64FX/220727/Examples_of_serial-code_opt_for_A64FX-RIST-20220725.pdf#page=8">Examples of serial-code optimization for A64FX processor cores</a></p></li>
</ul>
</section>
<section id="references">
<h2><span class="section-number">3.1.4. </span>References<a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/doc_root/en/manuals/tcsds-1.2.37/lang/Fortran/j2ul-2558-01enz0.pdf#page=270">Fortran User’s Guide “9.1.2.11 Loop Fission”</a></p></li>
<li><p><a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/doc_root/en/manuals/tcsds-1.2.37/lang/C/j2ul-2560-01enz0.pdf#page=77">C User’s Guide “3.3.10 Loop Fission”</a></p></li>
<li><p><a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/doc_root/en/manuals/tcsds-1.2.37/lang/C++/j2ul-2561-01enz0.pdf#page=80">C++ User’s Guide “3.3.10 Loop Fission”</a></p></li>
<li><p><a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/doc_root/en/programming_guides/Fortran_Programming_Guide.pdf#page=54">Programming Guide (Fortran) “LOOP_FISSION”</a></p></li>
<li><p><a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/doc_root/en/programming_guides/app-tuning-pattern-English.pdf#page=28">CPU performance tuning based on the type of application “5.2 Tuning technique 1: Optimizing instruction scheduling”</a></p></li>
</ul>
<p>Notice: Access rights for
<a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/en/">Fugaku User Portal</a>
are required to read the above documents.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="simd.html">2. Promoting Vectorization</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="calcwait.html">3. Reduction of Waiting Time for Calculation</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.1. Fission of Loop with Large Loop Body</a></li>
<li class="toctree-l2"><a class="reference internal" href="calcwait-striping.html">3.2. Striping of Innermost Loop with Small Iteration Count</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cachewait.html">4. Reduction of Waiting Time for Cache Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary.html">5. Summary</a></li>
</ul>

  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="calcwait.html"
                          title="previous chapter"><span class="section-number">3. </span>Reduction of Waiting Time for Calculation</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="calcwait-striping.html"
                          title="next chapter"><span class="section-number">3.2. </span>Striping of Innermost Loop with Small Iteration Count</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="calcwait-striping.html" title="3.2. Striping of Innermost Loop with Small Iteration Count"
             >next</a></li>
        <li class="right" >
          <a href="calcwait.html" title="3. Reduction of Waiting Time for Calculation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Documentation of Tuning Techniques for A64FX Processors</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="calcwait.html" ><span class="section-number">3. </span>Reduction of Waiting Time for Calculation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3.1. </span>Fission of Loop with Large Loop Body</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2023, RIKEN Center for Computational Science.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>