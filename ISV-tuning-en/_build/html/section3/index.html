

<!doctype html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>3. Tuning details and results &#8212;   documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/bizstyle.css?v=532c1bf3" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=89e52957" />
    
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. Tuning items" href="../section4/index.html" />
    <link rel="prev" title="2. Target performance and procedure of tuning" href="../section2/index.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../section4/index.html" title="4. Tuning items"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="../section2/index.html" title="2. Target performance and procedure of tuning"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3. </span>Tuning details and results</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="tuning-details-and-results">
<span id="section3"></span><h1><span class="section-number">3. </span>Tuning details and results<a class="headerlink" href="#tuning-details-and-results" title="Link to this heading">¶</a></h1>
<p>This chapter describes the details and results of the tuning performed
according to the procedure in Section 2.2 (<a class="reference internal" href="../section2/index.html#tuningmethods"><span class="std std-ref">Procedure of tuning</span></a>).</p>
<section id="evaluation-of-the-performance">
<span id="elapsedtime"></span><h2><span class="section-number">3.1. </span>Evaluation of the performance<a class="headerlink" href="#evaluation-of-the-performance" title="Link to this heading">¶</a></h2>
<p>To compare with the performance after performing the tuning, the
execution time of the Application was measured before performing the
tuning. In this tuning work, the Application was divided into
measurement regions by reference to the log files that were output by
the Application, and the execution time of each measurement region was
also measured to make it easier to evaluate the effects of tuning. When
discussing the execution time of the Application in this document, both
the execution time of the entire Application and the execution time of
each measurement region must be described.</p>
<p>The measurement regions are composed of three portions: “Solver”,
“Limiter functions processes”, and “Remnants of the entire
Application”. Execution time of “Remnants of the entire Application” is
defined as execution time of the entire Application minus execution time
of “Solver” and “Limiter functions processes”.</p>
<p>“Solver” was further divided into four portions: “Solving the system of
equations”, “Making the system of equations”, “Processing the
equations other than system of equations”, and “Remnants of
Solver”. Execution time of “Remnants of Solver” is defined as
execution time of “Solver” minus execution time of other 3 portions.</p>
<p>The following table shows the execution time of initial version
and the execution time of each measurement region. As seen in the table,
“Solving the system of equations” is the largest measurement region, and
it is 43% of the entire Application.</p>
<a class="reference internal image-reference" href="../_images/table1.png"><img alt="../_images/table1.png" class="align-center" src="../_images/table1.png" style="width: 602.3100000000001px; height: 289.51000000000005px;" /></a>
</section>
<section id="cost-of-each-function">
<span id="fippcost"></span><h2><span class="section-number">3.2. </span>Cost of each function<a class="headerlink" href="#cost-of-each-function" title="Link to this heading">¶</a></h2>
<p>In order to focus on the target functions for tuning, the cost of each
function, which is proportional to the execution time of each function,
in the initial version was measured by sampling analysis using fipp. As
a result, in the initial version with the condition of the tuning, 1645
functions and their costs were output by fipp.</p>
<p>The following table represents the top ten functions by the result of
cost information by fipp as samples. Each column in the table represents
the following:</p>
<ul class="simple">
<li><p>Function: the name of the function</p></li>
<li><p>Measurement region: the name of the measurement region that includes
the function in the column “Function”</p></li>
<li><p>Cost: the cost of each function output by fipp</p></li>
<li><p>Percentage of the cost: the percentage of each function’s cost in
relation to the total cost of the Application</p></li>
<li><p>Cumulative percentage of the cost: the cumulative percentage of the
cost for each function from the first one</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Function</p></th>
<th class="head"><p>Measurement region</p></th>
<th class="head"><p>Cost</p></th>
<th class="head"><p>Percentage of
the cost [%]</p></th>
<th class="head"><p>Cumulative percentage
of the cost [%]</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>(the entire Application)</p></td>
<td><p>―</p></td>
<td><p>10145395</p></td>
<td><p>100.00</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of
equations</p></td>
<td><p>2359630</p></td>
<td><p>23.26</p></td>
<td><p>23.26</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>function_of_MPI_1</p></td>
<td><p>(Related to wait time of an
MPI communications)</p></td>
<td><p>1818309</p></td>
<td><p>17.92</p></td>
<td><p>41.18</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>function_of_MPI_2</p></td>
<td><p>(Related to wait time of an
MPI communications)</p></td>
<td><p>1090237</p></td>
<td><p>10.75</p></td>
<td><p>51.93</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>make_function_1</p></td>
<td><p>Making the system of
equations</p></td>
<td><p>359086</p></td>
<td><p>3.54</p></td>
<td><p>55.47</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>make_function_2</p></td>
<td><p>Making the system of
equations</p></td>
<td><p>323755</p></td>
<td><p>3.19</p></td>
<td><p>58.66</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>limiter_function_1</p></td>
<td><p>Limiter functions processes</p></td>
<td><p>290204</p></td>
<td><p>2.86</p></td>
<td><p>61.52</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>calc_function_2</p></td>
<td><p>Solving the system of
equations</p></td>
<td><p>187961</p></td>
<td><p>1.85</p></td>
<td><p>63.37</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>make_function_3</p></td>
<td><p>Making the system of
equations</p></td>
<td><p>176418</p></td>
<td><p>1.74</p></td>
<td><p>65.11</p></td>
</tr>
<tr class="row-odd"><td><p>9</p></td>
<td><p>calc_function_3</p></td>
<td><p>Solving the system of
equation</p></td>
<td><p>165032</p></td>
<td><p>1.63</p></td>
<td><p>66.74</p></td>
</tr>
<tr class="row-even"><td><p>10</p></td>
<td><p>make_function_4</p></td>
<td><p>Making the system of
equations</p></td>
<td><p>156562</p></td>
<td><p>1.54</p></td>
<td><p>68.28</p></td>
</tr>
</tbody>
</table>
<p>As seen in the table , each cost of the top three functions were larger
than 10%, and the sum of their costs is more than 50% of the entire
Application.</p>
<p>The function with the highest cost was function “calc_function_1”, which
was in the measurement region “Solving the system of equations”, and the
percentage of the cost was 23% of the total. The functions
“function_of_MPI_1” and “function_of_MPI_2” followed “calc_function_1”.
However, they were related to wait time of an MPI communication, hence
it was not possible to tune these functions directly.</p>
<p>As seen in the cost of functions other than the top three functions, the
percentage of the cost of the fourth function was 3.54% of the total,
and the tenth function was only 1.54%. It means that the percentage of
the cost of most functions was less than a few percent in the initial
version.</p>
</section>
<section id="tuning-of-the-application">
<h2><span class="section-number">3.3. </span>Tuning of the Application<a class="headerlink" href="#tuning-of-the-application" title="Link to this heading">¶</a></h2>
<p>This section describes the tuning items and the Application performance
measured after performing the tuning.</p>
<section id="tuning-items">
<span id="tuninglist"></span><h3><span class="section-number">3.3.1. </span>Tuning items<a class="headerlink" href="#tuning-items" title="Link to this heading">¶</a></h3>
<p>The following table represents the tuning details and target functions
of all tuning items. Each column in the table represents the following:</p>
<ul class="simple">
<li><p>Tuning #: item number for tuning items (Tuning items are assigned
numbers in the order in which they were performed.)</p></li>
<li><p>Tuning outline: outline of each tuning item</p></li>
<li><p>Tuning method: the method for performing the tuning, such as
specifying OCL(s) (Optimization Control Line) or changing compiler
options</p></li>
<li><p>Classification of tuning: classification by reference to the
“Programming Guide (Tuning)” that is posted on the user portal site</p></li>
<li><p>Target function: the name of target function of each tuning item</p></li>
<li><p>Measurement region: the name of the measurement region that includes
the function in the column “Target function”</p></li>
<li><p>Section #: section number where the details of the tuning item are
described</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Tuning
#</p></th>
<th class="head"><p>Tuning outline</p></th>
<th class="head"><p>Tuning method</p></th>
<th class="head"><p>Classification of tuning</p></th>
<th class="head"><p>Target function</p></th>
<th class="head"><p>Measurement region</p></th>
<th class="head"><p>Section #</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Loop collapse, and unrolling for loops
with small iteration counts</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Specifying the prefetch instructions</p></td>
<td><p>Specify the OCL only</p></td>
<td><p>Improved data access waiting by hiding latency</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Sequential access of addition operations in
loops</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved data access waiting by hiding latency</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>Loop unrolling</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>Loop unrolling</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>Suppressing the faddv instructions</p></td>
<td><p>Add extra compile options</p></td>
<td><p>Reduction in the number of instructions</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>7</p></td>
<td rowspan="2"><p>Loop unrolling</p></td>
<td rowspan="2"><p>Specify the OCL only</p></td>
<td rowspan="2"><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>make_function_2</p></td>
<td><p>Making the system of equations</p></td>
<td rowspan="2"><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>make_function_3</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>Reordering off-diagonal elements in matrixes</p></td>
<td><p>Change the source code</p></td>
<td><p>Sequential access</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td rowspan="5"><p>9</p></td>
<td rowspan="5"><p>Suppression of SIMDization for loops
with small iteration counts</p></td>
<td rowspan="5"><p>Specify the OCL only</p></td>
<td rowspan="5"><p>Reduction in the number of instructions</p></td>
<td><p>calc_function_3</p></td>
<td><p>Solving the system of equations</p></td>
<td rowspan="5"><p>―</p></td>
</tr>
<tr class="row-even"><td><p>make_function_1</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>make_function_4</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>make_function_5</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>make_function_6</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>10</p></td>
<td><p>SIMDization of division operations and
suppression of SIMDization for loops
with small iteration counts</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>calc_function_3</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>Section 4.1</p></td>
</tr>
<tr class="row-odd"><td><p>11</p></td>
<td><p>Reducing load and store operations
of data by loop unrolling</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>Section 4.2</p></td>
</tr>
<tr class="row-even"><td><p>12</p></td>
<td><p>Loop unswitching</p></td>
<td><p>Specify the OCL only</p></td>
<td><p>Improved data access waiting by hiding latency</p></td>
<td><p>make_function_5</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>13</p></td>
<td><p>Loop unrolling</p></td>
<td><p>Specify the OCL only</p></td>
<td><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>make_function_2</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>14</p></td>
<td><p>Changing the parameters of domain
decomposition of input models</p></td>
<td><p>Change settings at execution</p></td>
<td><p>Improved the load balance between MPI processes</p></td>
<td><p>―</p></td>
<td><p>―</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>15</p></td>
<td><p>Removing extra type conversion instructions</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions</p></td>
<td><p>make_function_2</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>16</p></td>
<td><p>SIMDization by loop collapse</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>make_function_6</p></td>
<td><p>Making the system of equations</p></td>
<td><p>Section 4.3</p></td>
</tr>
<tr class="row-odd"><td><p>17</p></td>
<td><p>SIMDization by loop fission</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>make_function_2</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td rowspan="7"><p>18</p></td>
<td rowspan="7"><p>Inline expansion</p></td>
<td rowspan="7"><p>Change the source code</p></td>
<td rowspan="7"><p>Reduction in the number of instructions</p></td>
<td><p>limiter_function_1</p></td>
<td><p>Limiter functions processes</p></td>
<td rowspan="7"><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>make_function_1</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>make_function_4</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>make_function_9</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>calc_function_2</p></td>
<td><p>Solving the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>calc_function_3</p></td>
<td><p>Solving the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>calc_function_5</p></td>
<td><p>Solving the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>19</p></td>
<td><p>Changing the access direction of arrays</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved data access waiting by hiding latency</p></td>
<td><p>othSolv_function_3</p></td>
<td><p>Processing the equations other
than system of equations</p></td>
<td><p>Section 4.4</p></td>
</tr>
<tr class="row-even"><td><p>20</p></td>
<td><p>Movement of invariant expressions</p></td>
<td><p>Change the source code</p></td>
<td><p>Improve waiting for operations by hiding latency</p></td>
<td><p>make_function_8</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>21</p></td>
<td><p>Loop fission</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>make_function_8</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>22</p></td>
<td><p>Allocating some arrays in loops to register</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved data access waiting by hiding latency</p></td>
<td><p>make_function_8</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>23</p></td>
<td><p>Reducing the extra cost in calculation
operations</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions</p></td>
<td><p>make_function_8</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>24</p></td>
<td><p>SIMDization by SVE ACLE</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>calc_function_4</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>Section 4.5</p></td>
</tr>
<tr class="row-odd"><td rowspan="3"><p>25</p></td>
<td rowspan="3"><p>Built-in prefetch</p></td>
<td rowspan="3"><p>Change the source code</p></td>
<td rowspan="3"><p>Improved data access waiting by hiding latency</p></td>
<td><p>make_function_2</p></td>
<td><p>Making the system of equations</p></td>
<td rowspan="3"><p>Section 4.6</p></td>
</tr>
<tr class="row-even"><td><p>make_function_3</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>make_function_7</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>26</p></td>
<td><p>Allocating some arrays to static arrays
for SIMDization</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>27</p></td>
<td rowspan="2"><p>Using CLONE specifier, and loop unrolling</p></td>
<td rowspan="2"><p>Change the source code</p></td>
<td rowspan="2"><p>Improved data access waiting by hiding latency</p></td>
<td><p>make_function_6</p></td>
<td><p>Making the system of equations</p></td>
<td rowspan="2"><p>―</p></td>
</tr>
<tr class="row-even"><td><p>make_function_12</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>28</p></td>
<td><p>Moving division operations to outside of the
loop, and applying SIMDization to the
division operations</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>make_function_7</p></td>
<td><p>Making the system of equations</p></td>
<td><p>Section 4.7</p></td>
</tr>
<tr class="row-even"><td rowspan="3"><p>29</p></td>
<td rowspan="3"><p>Built-in prefetch</p></td>
<td rowspan="3"><p>Change the source code</p></td>
<td rowspan="3"><p>Improved data access waiting by hiding latency</p></td>
<td><p>othSolv_function_1</p></td>
<td><p>Processing the equations other
than system of equations</p></td>
<td rowspan="3"><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>othSolv_function_2</p></td>
<td><p>Processing the equations other
than system of equations</p></td>
</tr>
<tr class="row-even"><td><p>othSolv_function_5</p></td>
<td><p>Processing the equations other
than system of equations</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>30</p></td>
<td rowspan="2"><p>SIMDization by inline expansion</p></td>
<td rowspan="2"><p>Change the source code</p></td>
<td rowspan="2"><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>function_1</p></td>
<td><p>Processing the equations other
than system of equations</p></td>
<td rowspan="2"><p>―</p></td>
</tr>
<tr class="row-even"><td><p>function_2</p></td>
<td><p>Processing the equations other
than system of equations</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>31</p></td>
<td rowspan="2"><p>Thread parallelization</p></td>
<td rowspan="2"><p>Change the source code</p></td>
<td rowspan="2"><p>Thread parallelization</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td rowspan="2"><p>―</p></td>
</tr>
<tr class="row-even"><td><p>make_function_7</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>32</p></td>
<td><p>Improving load instructions scheduling</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved instruction scheduling with loop optimization</p></td>
<td><p>othSolv_function_4</p></td>
<td><p>Processing the equations other</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>33</p></td>
<td><p>Moving invariant expressions to outside of
the loop</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved instruction scheduling with loop optimization</p></td>
<td><p>calc_function_2</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>Section 4.8</p></td>
</tr>
<tr class="row-odd"><td><p>34</p></td>
<td><p>Loop unrolling manually instead of OCLs</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>calc_function_4</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>Section 4.9</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>35</p></td>
<td rowspan="2"><p>Allocating some arrays in loops to register</p></td>
<td rowspan="2"><p>Change the source code</p></td>
<td rowspan="2"><p>Improved data access waiting by hiding latency</p></td>
<td><p>calc_function_4</p></td>
<td><p>Solving the system of equations</p></td>
<td rowspan="2"><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>calc_function_5</p></td>
<td><p>Solving the system of equations</p></td>
</tr>
<tr class="row-even"><td><p>36</p></td>
<td><p>Loop interleaving</p></td>
<td><p>Change the source code</p></td>
<td><p>Improve waiting for operations by hiding latency</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>37</p></td>
<td><p>Removing extra type conversion instruction</p></td>
<td><p>Change the source code</p></td>
<td><p>Reduction in the number of instructions</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>38</p></td>
<td><p>Specifying the prefetch instructions</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved data access waiting by hiding latency</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>39</p></td>
<td rowspan="2"><p>Loop collapse</p></td>
<td rowspan="2"><p>Change the source code</p></td>
<td rowspan="2"><p>Improved instruction scheduling with loop optimization</p></td>
<td><p>make_function_6</p></td>
<td><p>Making the system of equations</p></td>
<td rowspan="2"><p>―</p></td>
</tr>
<tr class="row-even"><td><p>make_function_5</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td rowspan="3"><p>40</p></td>
<td rowspan="3"><p>Using CLONE specifier, and inline expansion</p></td>
<td rowspan="3"><p>Change the source code</p></td>
<td rowspan="3"><p>Reduction in the number of instructions, and Improved instruction scheduling with loop optimization</p></td>
<td><p>make_function_6</p></td>
<td><p>Making the system of equations</p></td>
<td rowspan="3"><p>―</p></td>
</tr>
<tr class="row-even"><td><p>make_function_5</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-odd"><td><p>make_function_7</p></td>
<td><p>Making the system of equations</p></td>
</tr>
<tr class="row-even"><td rowspan="7"><p>41</p></td>
<td rowspan="7"><p>Improving the memory placement of
two-dimensional arrays for sequential access</p></td>
<td rowspan="7"><p>Change the source code</p></td>
<td rowspan="7"><p>Sequential access</p></td>
<td><p>allocate_array</p></td>
<td><p>(the entire Application)</p></td>
<td rowspan="7"><p>Section 4.10</p></td>
</tr>
<tr class="row-odd"><td><p>clear_array</p></td>
<td><p>(the entire Application)</p></td>
</tr>
<tr class="row-even"><td><p>deallocate_array</p></td>
<td><p>(the entire Application)</p></td>
</tr>
<tr class="row-odd"><td><p>reallocate_array</p></td>
<td><p>(the entire Application)</p></td>
</tr>
<tr class="row-even"><td><p>allocate_array_2</p></td>
<td><p>(the entire Application)</p></td>
</tr>
<tr class="row-odd"><td><p>deallocate_array_2</p></td>
<td><p>(the entire Application)</p></td>
</tr>
<tr class="row-even"><td><p>reallocate_array_2</p></td>
<td><p>(the entire Application)</p></td>
</tr>
<tr class="row-odd"><td><p>42</p></td>
<td><p>SIMDization based on the Tuning #41</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved operation wait for facilitation of SIMDization</p></td>
<td><p>calc_function_1</p></td>
<td><p>Solving the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-even"><td><p>43</p></td>
<td><p>Using CLONE specifier</p></td>
<td><p>Change the source code</p></td>
<td><p>Improved instruction scheduling with loop optimization</p></td>
<td><p>make_function_7</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
<tr class="row-odd"><td><p>44</p></td>
<td><p>Suppression of SIMDization for loops which
has built-in prefetch functions</p></td>
<td><p>Specify the OCL only</p></td>
<td><p>Reduction in the number of instructions</p></td>
<td><p>make_function_7</p></td>
<td><p>Making the system of equations</p></td>
<td><p>―</p></td>
</tr>
</tbody>
</table>
<p>This document describes ten of forty-four tuning items as samples in
Chapter 4 (<a class="reference internal" href="../section4/index.html#section4"><span class="std std-ref">Tuning items</span></a>). The details of these ten tuning items are as follows:</p>
<ul>
<li><p><strong>The tuning with local code changes</strong></p>
<p>These are tuning items that improve performance without significant
changes to the source code, such as specifying the OCL(s) in Section
4.2.</p>
<blockquote>
<div><ul class="simple">
<li><p>Section 4.1: <a class="reference internal" href="../section4/4p1.html#p1"><span class="std std-ref">SIMDization of division operations and suppression of SIMDization for loops with small iteration counts</span></a></p></li>
<li><p>Section 4.2: <a class="reference internal" href="../section4/4p2.html#p2"><span class="std std-ref">Reducing load and store operations of data by loop unrolling</span></a></p></li>
<li><p>Section 4.3: <a class="reference internal" href="../section4/4p3.html#p3"><span class="std std-ref">SIMDization by loop collapse</span></a></p></li>
<li><p>Section 4.4: <a class="reference internal" href="../section4/4p4.html#p4"><span class="std std-ref">Changing the access direction of arrays</span></a></p></li>
<li><p>Section 4.7: <a class="reference internal" href="../section4/4p7.html#p7"><span class="std std-ref">Moving division operations to outside of the loop, and applying SIMDization to the division operations</span></a></p></li>
<li><p>Section 4.8: <a class="reference internal" href="../section4/4p8.html#p8"><span class="std std-ref">Moving invariant expressions to outside of the loop</span></a></p></li>
<li><p>Section 4.9: <a class="reference internal" href="../section4/4p9.html#p9"><span class="std std-ref">Loop unrolling manually instead of OCLs</span></a></p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Advanced tuning for improving the performance of the A64FX
processor</strong></p>
<p>These are tuning items that take advantage of the characteristics of
the A64FX processor to improve performance, such as using SVE ACLE,
specific to Arm, in Section 4.5.</p>
<blockquote>
<div><ul class="simple">
<li><p>Section 4.5: <a class="reference internal" href="../section4/4p5.html#p5"><span class="std std-ref">SIMDization by SVE ACLE</span></a></p></li>
<li><p>Section 4.6: <a class="reference internal" href="../section4/4p6.html#p6"><span class="std std-ref">Built-in prefetch</span></a></p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Tuning to the functions which are called from many other
functions</strong></p>
<p>The targets of tuning, described in Section 4.10, are some functions
that allocate or deallocate memory for two-dimensional arrays. While the
cost of each function was low, these were called by many other
functions. Therefore, tuning these functions was expected to improve the
performance of the entire Application.</p>
<blockquote>
<div><ul class="simple">
<li><p>Section 4.10: <a class="reference internal" href="../section4/4p10.html#p10"><span class="std std-ref">Improving the memory placement of two-dimensional arrays for sequential access</span></a></p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="tuning-results">
<span id="tuningresult"></span><h3><span class="section-number">3.3.2. </span>Tuning results<a class="headerlink" href="#tuning-results" title="Link to this heading">¶</a></h3>
<p>The following table represents the execution time of the initial version
and the tuned version (performed tuning items of #1 to #44), and the
performance improvement rate comparison between the initial version and
the tuned version. As seen in the table, the performance improvement
rate of the entire Application is 58%, in other words, the execution
time of the tuned version was less than half of the initial version,
thus the target performance was achieved.</p>
<a class="reference internal image-reference" href="../_images/table4.png"><img alt="../_images/table4.png" class="align-center" src="../_images/table4.png" style="width: 619.6500000000001px; height: 312.8px;" /></a>
<p>In this tuning work, the performance of the Application was measured 13
times in the process of performing the 44 tuning items, and the
following each graph (Figure 1 or Figure 2) shows these results. In
Figure 1, the horizontal axis represents the n-th tuning item as listed
in the table in Section 3.3.1 (<a class="reference internal" href="#tuninglist"><span class="std std-ref">Tuning items</span></a>), and the vertical one represents the
execution time of the Application measured just after the n-th tuning.
Note that height of the vertical bar and the number at the top indicate
the execution time of the entire Application. In Figure 2, the
horizontal axis represents the same as Figure 1, and the vertical one
represents the performance improvement rate, comparing the initial
version and after performing the n-th tuning.</p>
<p>For example, the number “8”on the horizontal axis indicates that the
Application measured just after the 8th tuning item as listed in the
table in Section 3.3.1 (<a class="reference internal" href="#tuninglist"><span class="std std-ref">Tuning items</span></a>). Hence, the data at the vertical axis “8” in
Figure 1 shows the execution time of the Application after performing
the tuning items #1 to #8. Note that the data at the position of the
horizontal axis 0 shows the data of initial version.</p>
<p>Figure 1: The execution time of the entire Application measured just
after performing the n-th tuning.</p>
<a class="reference internal image-reference" href="../_images/image1_1.png"><img alt="../_images/image1_1.png" class="align-center" src="../_images/image1_1.png" style="width: 723.6px; height: 366.3px;" /></a>
<p>Figure 2: The performance improvement rate, comparing the initial
version and after performing the n-th tuning.</p>
<a class="reference internal image-reference" href="../_images/image1_2.png"><img alt="../_images/image1_2.png" class="align-center" src="../_images/image1_2.png" style="width: 724.05px; height: 315.59999999999997px;" /></a>
<p>As seen in the Figure 2, the entire Application was improved by about
34% and the performance of the “Solving the system of equations“ was
improved by about 68% from the 1st to the 13th tuning item. The first 13
tuning items were targeted for the top eight highest cost functions, and
especially 7 of them were targeted for the function “calc_function_1”,
which was the function with highest cost in the initial version.</p>
<p>In Figure 2, the graph shows a steep increase of “the entire
Application” (about 34% to 40%) from the 13th to the 14th tuning item.
The 14th tuning item improved the load imbalance between processes by
changing execution parameters of the domain decomposition of the
Application, and it was performed according to the suggestion given by
the ISV who developed the Application.</p>
<p>Additionally, the performance of the entire Application further improved
by about 18% by performing the 15th to the 44th tuning item, which was
targeted for lower-cost (other than the top three functions in the table
in Section 3.2) functions. Therefore, each performance improvement rate
of the tuning item to the entire Application was smaller than those of
the 1st to the 14th tuning item.</p>
<p>Focusing on the performance improvement rate for each measurement region
in Figure 2, tuning items #1 to #13 contribute significantly to the
performance improvement of “Solving the system of equations”. Similarly,
#14 contributes to “Remnants of Solver”, #15 to #26
contribute to “Limiter functions processes”, and #28 to #30 contribute
to “Processing the equations other than system of equations”.</p>
<p>In summary, 44 tuning items were performed, which led to the reduction
of the execution time of the entire Application from 202.9 seconds to
85.0 seconds (about 2.4 times faster) and the achievement of the target
performance (reduction of the execution time to less than half). The
details are as follows:</p>
<ul class="simple">
<li><p>40 items were targeted for the top 30 functions that account for about
52% (except functions related to the MPI communications) of the
entire Application.</p></li>
<li><p>2 items were targeted for the low-cost functions that were called from
various parts of this Application (one of which was described in
Section 4.10 (<a class="reference internal" href="../section4/4p10.html#p10"><span class="std std-ref">Improving the memory placement of two-dimensional arrays for sequential access</span></a>)).</p></li>
<li><p>1 item: improvement of load balance between processes</p></li>
<li><p>1 item: implementation of thread parallelization</p></li>
</ul>
<div class="admonition-column-for-large-scale-simulations-at-fugaku admonition">
<p class="admonition-title">Column: For large-scale simulations at Fugaku</p>
<p>The tuning items #14 and #31 are especially important to execute the
large-scale simulations using hundreds of thousands of CPU cores, which
are required by users.</p>
<blockquote>
<div><div class="line-block">
<div class="line">#14: Changing the parameters of domain decomposition of input models</div>
</div>
<p>In this tuning item, the parameters of decomposition were changed to
improve the load balance between MPI processes. Improving the load
balance between MPI processes leads to reduce the communication
latency between MPI processes. Also, the impact on the latency will
be getting larger as the number of processes increases. Therefore, it
is important to balance the amount of operations performed by each
process.</p>
<div class="line-block">
<div class="line">#31: Thread parallelization</div>
</div>
<p>The initial version of the Application did not support thread
parallelization. However, thread parallelism is crucial for executing
the large-scale simulations using hundreds of thousands of CPU cores
more efficiently. Therefore, thread parallelization was performed.
This is the first time that thread parallelization has been performed
on the Application. In this tuning item, thread parallelization was
performed only for the functions “cal_function_1” and
“make_function_7”, which do not include factors inhibiting thread
parallelization such as data conflicts, were therefore easy to
implement. The percentage of the cost of the two functions accounted
for about 25% in the initial version.</p>
</div></blockquote>
<p>The execution conditions, such as the model and parallel number, in this
tuning work are not large enough to evaluate the performance of
large-scale simulations using hundreds of thousands of CPU cores.
Therefore, after the 44 tuning items were performed, a simulation of the
larger-scale model with about 800 million elements was carried out on
Fugaku to evaluate the effect of the tuning. The simulation was executed
using over 4000 compute nodes, with hybrid MPI-OpenMP parallelism (with
4 threads). As a result, it completed with up to about 220,000 CPU
cores, and also the speed-up was observed up to about 200,000 CPU cores.
The execution of the much larger-scale simulations is expected by
further improvements, such as thread parallelization of the other loops.</p>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">3. Tuning details and results</a><ul>
<li><a class="reference internal" href="#evaluation-of-the-performance">3.1. Evaluation of the performance</a></li>
<li><a class="reference internal" href="#cost-of-each-function">3.2. Cost of each function</a></li>
<li><a class="reference internal" href="#tuning-of-the-application">3.3. Tuning of the Application</a><ul>
<li><a class="reference internal" href="#tuning-items">3.3.1. Tuning items</a></li>
<li><a class="reference internal" href="#tuning-results">3.3.2. Tuning results</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../section2/index.html"
                          title="previous chapter"><span class="section-number">2. </span>Target performance and procedure of tuning</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../section4/index.html"
                          title="next chapter"><span class="section-number">4. </span>Tuning items</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../section4/index.html" title="4. Tuning items"
             >next</a></li>
        <li class="right" >
          <a href="../section2/index.html" title="2. Target performance and procedure of tuning"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3. </span>Tuning details and results</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, RIKEN Center for Computational Science.
    &nbsp;&nbsp;<a href="https://www.fugaku.r-ccs.riken.jp/">Fugaku Portal Top</a>
    </div>
  </body>
</html>